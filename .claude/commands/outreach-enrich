#!/bin/bash
# ClutterFreeSpaces B2B Outreach - Contact Enrichment Command
# Usage: /outreach-enrich --batch=25 --type=cleaning_company

# Set up environment
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTREACH_DIR="$PROJECT_ROOT/outreach"

# Default values
BATCH_SIZE=25
BUSINESS_TYPE=""
DRY_RUN=false
FORCE_UPDATE=false
WEBSITES_ONLY=false

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --batch=*)
            BATCH_SIZE="${1#*=}"
            shift
            ;;
        --type=*)
            BUSINESS_TYPE="${1#*=}"
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --force)
            FORCE_UPDATE=true
            shift
            ;;
        --websites-only)
            WEBSITES_ONLY=true
            shift
            ;;
        --help|-h)
            echo "ClutterFreeSpaces B2B Contact Enrichment"
            echo ""
            echo "Usage: /outreach-enrich [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --batch=NUMBER      Number of businesses to enrich (default: 25)"
            echo "  --type=TYPE         Specific business type to enrich"
            echo "                      Options: cleaning_company, real_estate_agent, moving_company,"
            echo "                              storage_facility, rv_dealer, rv_park, rv_service, rv_rental"
            echo "  --dry-run           Show what would be enriched without making changes"
            echo "  --force             Re-enrich businesses that already have contact info"
            echo "  --websites-only     Only enrich businesses that have websites"
            echo "  --help, -h          Show this help message"
            echo ""
            echo "Examples:"
            echo "  /outreach-enrich --batch=10 --type=rv_dealer"
            echo "  /outreach-enrich --batch=50 --force"
            echo "  /outreach-enrich --websites-only --dry-run"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Header
echo -e "${BLUE}📧 ClutterFreeSpaces Contact Enrichment${NC}"
echo "================================================"
echo -e "${YELLOW}Batch Size:${NC} $BATCH_SIZE businesses"
if [[ -n "$BUSINESS_TYPE" ]]; then
    echo -e "${YELLOW}Business Type:${NC} $BUSINESS_TYPE"
else
    echo -e "${YELLOW}Business Type:${NC} All types"
fi
if [[ "$WEBSITES_ONLY" == "true" ]]; then
    echo -e "${YELLOW}Scope:${NC} Websites only"
fi
if [[ "$FORCE_UPDATE" == "true" ]]; then
    echo -e "${YELLOW}Mode:${NC} Force update (re-enrich existing contacts)"
fi
if [[ "$DRY_RUN" == "true" ]]; then
    echo -e "${YELLOW}Mode:${NC} Dry run (no database updates)"
fi
echo ""

# Build command arguments
ARGS="--batch=$BATCH_SIZE"
# Note: website_contact_extractor.py doesn't support --type filtering
# It processes all businesses with websites regardless of type
if [[ "$DRY_RUN" == "true" ]]; then
    ARGS="$ARGS --dry-run"
fi
# Note: --force and --websites-only are not supported by website_contact_extractor.py

# Run the contact enrichment
echo -e "${BLUE}Starting contact enrichment process...${NC}"
cd "$OUTREACH_DIR" || exit 1

if python3 scraping/website_contact_extractor.py $ARGS; then
    echo ""
    echo -e "${GREEN}✅ Contact enrichment completed successfully!${NC}"
    
    # Show enrichment statistics
    echo ""
    echo -e "${BLUE}📊 Enrichment Summary:${NC}"
    
    # Get stats from database
    STATS_QUERY="
    SELECT 
        COUNT(*) as total_businesses,
        COUNT(CASE WHEN website IS NOT NULL AND website != '' THEN 1 END) as with_websites,
        COUNT(CASE WHEN email IS NOT NULL AND email != '' THEN 1 END) as with_emails,
        COUNT(CASE WHEN phone IS NOT NULL AND phone != '' THEN 1 END) as with_phones
    FROM businesses;"
    
    if command -v sqlite3 >/dev/null 2>&1; then
        STATS=$(sqlite3 "$PROJECT_ROOT/.claude/data/metrics.db" "$STATS_QUERY" 2>/dev/null)
        if [[ -n "$STATS" ]]; then
            IFS='|' read -r total websites emails phones <<< "$STATS"
            echo "• Total Businesses: $total"
            echo "• With Websites: $websites"
            echo "• With Emails: $emails"
            echo "• With Phone Numbers: $phones"
        fi
    fi
    
    # Show next steps
    echo ""
    echo -e "${BLUE}📋 Next Steps:${NC}"
    echo "1. Review enriched contacts: /outreach-report --contacts --enriched"
    echo "2. Start outreach campaign: /outreach-campaign --create --type=$BUSINESS_TYPE"
    echo "3. Check data quality: /outreach-report --data-quality"
    echo "4. Run deduplication: /outreach-dedupe (when available)"
    
else
    echo ""
    echo -e "${RED}❌ Contact enrichment failed${NC}"
    echo "Common issues:"
    echo "• Rate limiting from websites - try smaller batch sizes"
    echo "• Network connectivity problems"
    echo "• Invalid business websites in database"
    echo ""
    echo "Try running with --dry-run first to see what would be processed"
    exit 1
fi