#!/bin/bash
# ClutterFreeSpaces B2B Outreach - Business Discovery Command
# Usage: /outreach-discover --type=rv_dealer --city=Missoula --limit=50

# Set up environment
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
OUTREACH_DIR="$PROJECT_ROOT/outreach"

# Load environment variables
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    set -a  # Export all variables
    source "$PROJECT_ROOT/.env"
    set +a  # Stop exporting
fi

# Default values
BUSINESS_TYPE=""
CITY=""
STATE="MT"
LIMIT=50
DRY_RUN=false
SAVE_JSON=false

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --type=*)
            BUSINESS_TYPE="${1#*=}"
            shift
            ;;
        --city=*)
            CITY="${1#*=}"
            shift
            ;;
        --state=*)
            STATE="${1#*=}"
            shift
            ;;
        --limit=*)
            LIMIT="${1#*=}"
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --save-json)
            SAVE_JSON=true
            shift
            ;;
        --help|-h)
            echo "ClutterFreeSpaces B2B Business Discovery"
            echo ""
            echo "Usage: /outreach-discover [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --type=TYPE     Business type to discover (required)"
            echo "                  Home Campaign: cleaning_company, real_estate_agent, moving_company, storage_facility"
            echo "                  RV Campaign: rv_dealer, rv_park, rv_service, rv_rental"
            echo "  --city=CITY     Specific city to search (optional, defaults to all Montana cities)"
            echo "  --state=STATE   State to search (default: MT)"
            echo "  --limit=NUMBER  Maximum businesses to discover (default: 50)"
            echo "  --dry-run       Show what would be discovered without saving"
            echo "  --save-json     Save results to JSON backup file"
            echo "  --help, -h      Show this help message"
            echo ""
            echo "Examples:"
            echo "  /outreach-discover --type=rv_dealer --city=Missoula --limit=20"
            echo "  /outreach-discover --type=cleaning_company --dry-run"
            echo "  /outreach-discover --type=real_estate_agent --save-json"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Validate required parameters
if [[ -z "$BUSINESS_TYPE" ]]; then
    echo -e "${RED}Error: --type is required${NC}"
    echo "Use --help to see available business types"
    exit 1
fi

# Header
echo -e "${BLUE}üîç ClutterFreeSpaces Business Discovery${NC}"
echo "================================================"
echo -e "${YELLOW}Business Type:${NC} $BUSINESS_TYPE"
if [[ -n "$CITY" ]]; then
    echo -e "${YELLOW}Location:${NC} $CITY, $STATE"
else
    echo -e "${YELLOW}Location:${NC} All Montana cities"
fi
echo -e "${YELLOW}Limit:${NC} $LIMIT businesses"
if [[ "$DRY_RUN" == "true" ]]; then
    echo -e "${YELLOW}Mode:${NC} Dry run (no saving to database)"
fi
echo ""

# Build command arguments
ARGS="--type=$BUSINESS_TYPE --limit=$LIMIT"
if [[ -n "$CITY" ]]; then
    ARGS="$ARGS --city=$CITY --state=$STATE"
fi
if [[ "$DRY_RUN" == "true" ]]; then
    ARGS="$ARGS --dry-run"
fi
if [[ "$SAVE_JSON" == "true" ]]; then
    ARGS="$ARGS --save-json"
fi

# Run the Google Maps scraper
echo -e "${BLUE}Running Google Maps business discovery...${NC}"
cd "$OUTREACH_DIR" || exit 1

if python3 scraping/google_maps_scraper.py $ARGS; then
    echo ""
    echo -e "${GREEN}‚úÖ Business discovery completed successfully!${NC}"
    
    # Show next steps
    echo ""
    echo -e "${BLUE}üìã Next Steps:${NC}"
    echo "1. Run contact enrichment: /outreach-enrich --batch=25"
    echo "2. Create outreach campaign: /outreach-campaign --create --type=$BUSINESS_TYPE"
    echo "3. View discovered businesses: /outreach-report --businesses --type=$BUSINESS_TYPE"
    
else
    echo ""
    echo -e "${RED}‚ùå Business discovery failed${NC}"
    echo "Check the logs for more details"
    exit 1
fi